@page "{id:int}"
@using Microsoft.AspNetCore.Identity

@using No_Forum.Models 
@model No_Forum.Pages.ContentPageViewerModel
@{
    var currentUserId = User.Identity?.IsAuthenticated == true
        ? Model.AllUsers.FirstOrDefault(u => u.UserName == User.Identity.Name)?.Id
        : null;
}


<p>@Model.Post?.Text</p>
@if (!string.IsNullOrEmpty(Model.Post?.ImagePath))
{
    <img src="@Model.Post.ImagePath" alt="Post image" style="max-width:100%; height:auto;" />
}

<h3>Comments</h3>
@if (Model.PostComments != null && Model.PostComments.Any())
{
    <ul>
        @foreach (var comment in Model.PostComments)
        {
            var commenter = Model.AllUsers.FirstOrDefault(u => u.UserName == comment.CreatedBy);
            var commenterId = commenter?.Id;
            var pfp = commenterId != null
            ? Model.AllPFPs.FirstOrDefault(p => p.UserId == commenterId && !string.IsNullOrEmpty(p.ProfilePicturePath))
            : null;

            var alreadyFriend = commenterId != null && Model.MyFriends.Any(f => f.FriendUserId == commenterId);
            var isSelf = commenterId == currentUserId;

            <li>
                @if (pfp != null && !string.IsNullOrEmpty(pfp.ProfilePicturePath))
                {
                    <img src="@Url.Content($"~/img/{pfp.ProfilePicturePath}")" alt="Profile Picture" style="width:32px;height:32px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:8px;" />
                }
                else
                {
                    <img src="@Url.Content("~/img/default.png")" alt="Profile Picture" style="width:32px;height:32px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:8px;" />
                }
                <strong>@(comment.CreatedBy ?? "Anonymous")</strong>
                @if (User.Identity?.IsAuthenticated == true && commenterId != null && !alreadyFriend && !isSelf)
                {
                    <form method="post" asp-page-handler="AddFriend" style="display:inline;">
                        <input type="hidden" name="friendUserId" value="@commenterId" />
                        <button type="submit" class="btn btn-link btn-sm">Follow</button>
                    </form>
                }
                <span class="text-muted" style="font-size:small;">
                    @comment.CreatedAt.ToLocalTime()
                </span>
                <div>@comment.Text</div>
                @if (User.IsInRole("Admin"))
                {
                    <form method="post" asp-page-handler="RemoveComment" asp-route-id="@comment.Id" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Remove this comment?');">Remove</button>
                    </form>
                }
            </li>
        }
    </ul>
}
else
{
    <p>No comments yet.</p>
}

<form method="post">
    <textarea asp-for="NewCommentText" rows="3" cols="50"></textarea>
    <br />
    <button type="submit">Add Comment</button>
</form>
